k8s should be >=1.20.6 

To install flux in gitops manner, we make use of the flux CLI, for all popular platforms, the flux CLI is available as an executable binary that can be downloaded from github.

`curl -s https://fluxcd.io/install.sh | sudo bash`

`source <(flux completion zsh)`

Once CLI is installed, next step is to install flux itself or the flux server. So we make use of **bootstrap** command. We can setup flux to manage itself from a git repo and install it on a k8s cluster using the flux bootstrap command. This bootstrap command will carry out and upgrade if the flux components are already on the cluster. Since the bootstrap command is idempotent we can run the command as much as we like without any risk. The bootstrap command can we used for git providers like github, bitbucket, az repos, aws codecommit. 


for now we are going to make use of github,

`flux bootstrap github --owner masudhan --repository gitops --path clusters/dev-gke --personal true --private false`

The bootstrap command will commit the manifest for the flux components to the specified branch and create a git repo if one doesn't already exists. Then it's going to setup an ssh deploy key or PAT to configure the target cluster to synchronize with that repository. It expects github PAT for authentication.

Now it's going to connect with github > create repo if doesn't exists > clones the repo > generates flux component manifest > commits and pushes them to repo to start the installation process > creates flux-system ns and install all the required components in it > Also creates SSH key which is stored as a secret in k8s cluster, the key is also used to create a deploy key within the github repo. It also synchronizes everything and completes the bootstrapping process. 

Once done, you can clone the gitops repo and you should be seeing the flux components being created and commited to repo.
```
clusters
└── dev-gke
    └── flux-system
        ├── gotk-components.yaml
        ├── gotk-sync.yaml
        └── kustomization.yaml
```

Now we can place plain k8s manifests inside the directory under the path, clusters/dev-gke. Flux will automatically reconcile them on the target cluster. 

For testing, we can use `flux install` to install flux without storing its manifests in git repo, we can uninstall using `flux uninstall -n flux-system`

`k -n flux-system get all`

`k -n flux-system get secret` - which has the public and private key generated by the bootstrap command

`k get crds | grep -i flux`

`flux version` - this show the version and all the flux controllers